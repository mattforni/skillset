#!/bin/bash
# Pre-commit hook for validating markdown files

set -e

echo "Running pre-commit validations..."

# Check if markdownlint-cli is installed
if ! command -v markdownlint &> /dev/null; then
  echo ""
  echo "⚠️  markdownlint-cli is not installed!"
  echo ""
  echo "Install it with:"
  echo "  npm install -g markdownlint-cli"
  echo ""
  echo "Or skip this hook with:"
  echo "  git commit --no-verify"
  echo ""
  exit 1
fi

# Check if jq is installed
if ! command -v jq &> /dev/null; then
  echo ""
  echo "⚠️  jq is not installed! It's required for JSON validation."
  echo ""
  echo "Install it with your package manager (e.g., 'brew install jq' or 'sudo apt-get install jq')"
  echo ""
  echo "Or skip this hook with:"
  echo "  git commit --no-verify"
  echo ""
  exit 1
fi

# Get list of staged markdown files
STAGED_MD_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.md$' || true)

if [ -z "$STAGED_MD_FILES" ]; then
  echo "✓ No markdown files to lint"
else
  echo "Linting staged markdown files..."
  echo "$STAGED_MD_FILES" | xargs markdownlint || {
    echo ""
    echo "❌ Markdown linting failed!"
    echo ""
    echo "Fix the issues above or skip this hook with:"
    echo "  git commit --no-verify"
    echo ""
    exit 1
  }
  echo "✓ All markdown files passed linting"
fi

# Validate JSON files
STAGED_JSON_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.json$' || true)

if [ -z "$STAGED_JSON_FILES" ]; then
  echo "✓ No JSON files to validate"
else
  echo "Validating staged JSON files..."
  echo "$STAGED_JSON_FILES" | while read file; do
    jq empty "$file" || {
      echo ""
      echo "❌ JSON validation failed for $file!"
      echo ""
      exit 1
    }
  done
  echo "✓ All JSON files are valid"
fi

# Validate shell scripts
STAGED_SH_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.sh$' || true)

if [ -z "$STAGED_SH_FILES" ]; then
  echo "✓ No shell scripts to validate"
else
  echo "Validating staged shell scripts..."
  echo "$STAGED_SH_FILES" | while read script; do
    bash -n "$script" || {
      echo ""
      echo "❌ Shell script validation failed for $script!"
      echo ""
      exit 1
    }
  done
  echo "✓ All shell scripts have valid syntax"
fi

echo ""
echo "✓ All pre-commit validations passed!"
